<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTIX PRO | 极客云中枢</title>
    <script src="/static/tailwind.js"></script>
    <script defer src="/static/alpine.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        [x-cloak] { display: none !important; }
        body { background-color: #020617; color: #f8fafc; scroll-behavior: smooth; }
        .glass { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-flat { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255,255,255,0.03); }
        .neon-border { border: 1px solid rgba(59, 130, 246, 0.4); box-shadow: 0 0 15px rgba(59, 130, 246, 0.1); }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body x-data="multix()" x-init="init()" class="antialiased font-sans pb-20">

<header class="max-w-7xl mx-auto px-6 pt-8 flex justify-between items-center">
    <div class="flex items-center gap-3">
        <h1 class="text-3xl font-black italic tracking-tighter text-blue-500">MULTIX <span class="text-white">PRO</span></h1>
        <span class="bg-blue-500/10 text-blue-400 text-[10px] px-2 py-1 rounded font-bold uppercase border border-blue-500/20">System Master</span>
    </div>
    <div class="flex items-center gap-4">
        <button @click="isRefreshing=true; fetchState()" class="p-2 hover:bg-white/5 rounded-full transition" :class="isRefreshing && 'animate-spin-slow'">
            <i class="ri-refresh-line text-xl text-slate-400"></i>
        </button>
        <div @click="openAdminModal()" class="flex items-center gap-2 px-4 py-2 bg-white/5 rounded-2xl border border-white/10 cursor-pointer hover:bg-white/10 transition group">
            <div class="w-1.5 h-1.5 bg-green-500 rounded-full shadow-[0_0_8px_#22c55e] animate-pulse"></div>
            <div class="flex flex-col">
                <span class="text-[8px] text-slate-500 font-black uppercase mb-1">Operator</span>
                <span class="text-xs font-black italic text-white group-hover:text-green-400 transition" x-text="config.user || 'ADMIN'"></span>
            </div>
            <i class="ri-equalizer-line text-slate-500 ml-2"></i>
        </div>
    </div>
</header>

<section class="max-w-7xl mx-auto px-6 mt-8 space-y-4">
    <div class="glass p-6 rounded-[2rem] neon-border flex flex-wrap items-center justify-between gap-6">
        <div class="flex items-center gap-6">
            <div class="bg-blue-600/20 p-4 rounded-2xl border border-blue-500/20">
                <i class="ri-server-line text-2xl text-blue-400"></i>
            </div>
            <div>
                <h2 class="text-lg font-black uppercase italic tracking-tight">Master Console</h2>
                <div class="flex gap-4 mt-1 text-[10px] text-slate-400">
                    <span x-text="'OS: ' + master.sys_ver"></span>
                    <span class="text-blue-400" x-text="'Sing-box: ' + (master.sb_ver || 'N/A')"></span>
                </div>
            </div>
            <div class="h-10 w-px bg-white/5 hidden md:block"></div>
            <div class="flex gap-6 text-xs">
                <div class="text-center"><p class="text-[8px] text-slate-500 uppercase">CPU</p><p class="font-bold" x-text="master.cpu+'%'"></p></div>
                <div class="text-center"><p class="text-[8px] text-slate-500 uppercase">MEM</p><p class="font-bold" x-text="master.mem+'%'"></p></div>
                <div class="text-center"><p class="text-[8px] text-slate-500 uppercase">Disk</p><p class="font-bold" x-text="master.disk+'%'"></p></div>
            </div>
        </div>
        <div class="flex gap-4 bg-black/40 p-3 rounded-2xl border border-white/5 text-[10px] font-mono">
            <div class="pr-4 border-r border-white/10"><p class="text-slate-500 uppercase italic text-[8px]">Endpoint</p><p class="text-green-400" x-text="config.ip4"></p></div>
            <div class="relative group">
                <p class="text-slate-500 uppercase italic text-[8px]">Token</p>
                <p class="text-yellow-500 cursor-pointer hover:text-white" @click="navigator.clipboard.writeText(config.token); alert('Token已复制')" x-text="config.token ? config.token.slice(0,8)+'****' : ''"></p>
            </div>
        </div>
    </div>
</section>

<main class="max-w-7xl mx-auto px-6 mt-8 space-y-3">
    <template x-for="(n, sid) in sortedAgents" :key="sid">
        <div class="glass-flat p-4 rounded-2xl flex flex-wrap items-center justify-between border border-white/5 hover:border-blue-500/20 transition-all group relative">
            <div class="flex items-center gap-4 w-full md:w-1/4">
                <div class="w-2.5 h-2.5 rounded-full shadow-[0_0_10px_rgba(34,197,94,0.3)]" :class="n.status=='online'?'bg-green-500 animate-pulse':'bg-red-500'"></div>
                <div>
                    <div class="flex items-center gap-2">
                        <h3 class="text-sm font-black uppercase" x-text="n.alias || n.hostname"></h3>
                        <span class="bg-blue-500/10 text-blue-400 text-[8px] px-1.5 py-0.5 rounded border border-blue-500/20 font-bold" x-text="(n.node_count || 0) + ' NODES'"></span>
                    </div>
                    <p class="text-[9px] text-slate-500 font-mono italic" x-text="n.ip"></p>
                </div>
            </div>
            <div class="flex-1 grid grid-cols-3 gap-8 px-4 md:px-12 my-4 md:my-0">
                <div class="space-y-1">
                    <div class="flex justify-between text-[8px] uppercase font-bold text-slate-500"><span>CPU</span><span x-text="(n.metrics?.cpu || 0)+'%'" class="text-white"></span></div>
                    <div class="h-1 bg-white/5 rounded-full overflow-hidden"><div class="bg-blue-500 h-full transition-all duration-500" :style="'width:'+(n.metrics?.cpu || 0)+'%'"></div></div>
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[8px] uppercase font-bold text-slate-500"><span>Mem</span><span x-text="(n.metrics?.mem || 0)+'%'" class="text-white"></span></div>
                    <div class="h-1 bg-white/5 rounded-full overflow-hidden"><div class="bg-blue-500 h-full transition-all duration-500" :style="'width:'+(n.metrics?.mem || 0)+'%'"></div></div>
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[8px] uppercase font-bold text-slate-500"><span>Disk</span><span x-text="(n.metrics?.disk || 0)+'%'" class="text-white"></span></div>
                    <div class="h-1 bg-white/5 rounded-full overflow-hidden"><div class="bg-blue-500 h-full transition-all duration-500" :style="'width:'+(n.metrics?.disk || 0)+'%'"></div></div>
                </div>
            </div>
            <div class="flex items-center gap-6 w-full md:w-auto justify-between md:justify-end">
                <div class="text-right font-mono">
                    <p class="text-[9px] text-blue-400 font-bold">↑ <span class="text-white" x-text="n.metrics?.net_up"></span>M</p>
                    <p class="text-[9px] text-blue-400 font-bold">↓ <span class="text-white" x-text="n.metrics?.net_down"></span>M</p>
                </div>
                <button @click="openDrawer(sid)" class="bg-white/5 hover:bg-blue-600 px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all border border-white/5">配置节点</button>
            </div>
            <div x-show="n.is_dirty" class="absolute -top-1 -left-1 w-2 h-2 bg-yellow-500 rounded-full shadow-[0_0_8px_#eab308]"></div>
        </div>
    </template>
</main>

<div x-show="drawer" x-cloak class="fixed inset-0 z-50 flex justify-end">
    <div x-transition.opacity class="absolute inset-0 bg-black/80 backdrop-blur-sm" @click="drawer=false"></div>
    <div x-transition:enter="transition ease-out duration-300" x-transition:enter-start="translate-x-full" x-transition:enter-end="translate-x-0" 
         class="relative w-full max-w-xl bg-[#020617] h-full border-l border-white/10 p-8 flex flex-col shadow-2xl">
        <div class="flex justify-between items-center mb-8">
            <div><h2 class="text-2xl font-black uppercase italic tracking-tighter">节点配置管理</h2><p class="text-[10px] text-blue-500 font-mono" x-text="curNode.alias || curNode.hostname"></p></div>
            <button @click="drawer=false" class="text-2xl text-slate-500 hover:text-white"><i class="ri-close-fill"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto space-y-6 pr-2 custom-scrollbar">
            <template x-for="(node, idx) in editNodes" :key="idx">
                <div class="glass p-5 rounded-3xl border-l-4 border-blue-600 relative">
                    <div class="flex justify-between items-center mb-4">
                        <input x-model="node.tag" class="bg-transparent text-sm font-black outline-none border-b border-white/10 focus:border-blue-500 w-2/3">
                        <button @click="editNodes.splice(idx, 1)" class="text-slate-600 hover:text-red-500"><i class="ri-delete-bin-line"></i></button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1"><label class="text-[9px] font-bold text-slate-500 uppercase italic">协议</label>
                            <select x-model="node.type" class="w-full bg-black/50 border border-white/10 rounded-xl p-2.5 text-xs outline-none text-white">
                                <option value="vless">VLESS</option><option value="hysteria2">Hysteria2</option><option value="shadowsocks">Shadowsocks</option>
                            </select>
                        </div>
                        <div class="space-y-1"><label class="text-[9px] font-bold text-slate-500 uppercase italic">端口</label>
                            <input type="number" x-model="node.listen_port" class="w-full bg-black/50 border border-white/10 rounded-xl p-2.5 text-xs font-mono outline-none text-white">
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-white/5">
                        <template x-if="node.type === 'vless'">
                            <div><label class="text-[9px] font-bold text-slate-500 uppercase flex justify-between">UUID <span @click="node.uuid = crypto.randomUUID()" class="text-blue-500 cursor-pointer text-[8px] hover:underline">随机生成</span></label>
                            <input x-model="node.uuid" class="w-full bg-black/50 border border-white/10 rounded-xl p-2.5 text-[10px] font-mono mt-1 outline-none text-white"></div>
                        </template>
                        <template x-if="node.type === 'hysteria2'">
                            <div class="grid grid-cols-2 gap-3"><div class="col-span-2"><label class="text-[9px] font-bold text-slate-500 uppercase">认证密码</label><input x-model="node.password" class="w-full bg-black/50 border border-white/10 rounded-xl p-2.5 text-xs mt-1 outline-none text-white"></div>
                            <div><label class="text-[9px] font-bold text-slate-500 uppercase italic">上行Mbps</label><input type="number" x-model="node.up_mbps" class="w-full bg-black/50 border border-white/10 rounded-xl p-2.5 text-xs outline-none text-white"></div>
                            <div><label class="text-[9px] font-bold text-slate-500 uppercase italic">下行Mbps</label><input type="number" x-model="node.down_mbps" class="w-full bg-black/50 border border-white/10 rounded-xl p-2.5 text-xs outline-none text-white"></div></div>
                        </template>
                    </div>
                </div>
            </template>
            <button @click="addEmptyNode()" class="w-full py-4 border-2 border-dashed border-white/5 rounded-2xl text-slate-500 hover:border-blue-500 hover:text-blue-500 transition-all font-black text-[10px] uppercase">新增节点配置</button>
        </div>
        <div class="mt-8 grid grid-cols-2 gap-4">
            <button @click="saveDraft()" class="py-4 rounded-xl bg-white/5 hover:bg-white/10 text-[10px] font-black uppercase transition border border-white/10 tracking-widest">暂存草稿</button>
            <button @click="syncPush()" class="py-4 rounded-xl bg-blue-600 hover:bg-blue-500 text-[10px] font-black uppercase transition shadow-lg shadow-blue-600/30 tracking-widest">同步重启</button>
        </div>
    </div>
</div>

<div x-show="adminModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-xl" x-cloak x-transition>
    <div class="bg-[#0a0a0c] w-full max-w-2xl rounded-[2.5rem] border border-white/10 overflow-hidden shadow-2xl" @click.away="adminModal = false">
        <div class="p-8 border-b border-white/5 flex justify-between items-center bg-white/2">
            <div>
                <h2 class="text-2xl font-black italic tracking-tighter text-white uppercase">System Control</h2>
                <p class="text-[10px] text-slate-500 font-bold uppercase mt-1">账户、虚拟资产与排序管理</p>
            </div>
            <button @click="adminModal = false" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 text-slate-400 hover:text-white transition"><i class="ri-close-line text-xl"></i></button>
        </div>
        <div class="p-8 space-y-10 max-h-[70vh] overflow-y-auto custom-scrollbar">
            <section class="space-y-4">
                <div class="flex items-center gap-2 mb-2"><i class="ri-shield-user-line text-green-500"></i><h3 class="text-xs font-black text-white uppercase tracking-widest">账户设置</h3></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/5 flex items-center justify-between group">
                        <div class="flex-1"><label class="text-[8px] text-slate-500 font-bold uppercase mb-1 block">用户名</label>
                            <span x-show="!isEditingUser" class="text-sm font-bold text-white" x-text="config.user"></span>
                            <input x-show="isEditingUser" x-model="tempUser" class="bg-black/40 border border-green-500/30 p-1 rounded text-sm text-green-400 outline-none w-full font-bold">
                        </div>
                        <button @click="isEditingUser = !isEditingUser; if(isEditingUser) tempUser = config.user" class="ml-4 p-2 rounded-lg hover:bg-white/5 text-blue-400"><i :class="isEditingUser ? 'ri-close-line text-red-400' : 'ri-edit-line'"></i></button>
                    </div>
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/5 flex items-center justify-between group">
                        <div class="flex-1"><label class="text-[8px] text-slate-500 font-bold uppercase mb-1 block tracking-widest">新密码</label>
                            <span x-show="!isEditingPass" class="text-sm font-black text-slate-600 italic">••••••••</span>
                            <input x-show="isEditingPass" type="password" x-model="tempPass" placeholder="留空不修改" class="bg-black/40 border border-green-500/30 p-1 rounded text-sm text-green-400 outline-none w-full font-bold">
                        </div>
                        <button @click="isEditingPass = !isEditingPass; if(isEditingPass) tempPass = ''" class="ml-4 p-2 rounded-lg hover:bg-white/5 text-blue-400"><i :class="isEditingPass ? 'ri-close-line text-red-400' : 'ri-edit-line'"></i></button>
                    </div>
                </div>
                <button x-show="isEditingUser || isEditingPass" @click="confirmUpdateAdmin()" class="w-full py-4 bg-green-500 text-black rounded-2xl text-[10px] font-black uppercase hover:bg-green-400 transition shadow-lg shadow-green-500/20">确认并保存账户修改</button>
            </section>
            <section class="space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2"><i class="ri-server-line text-blue-500"></i><h3 class="text-xs font-black text-white uppercase tracking-widest">节点控制</h3></div>
                    <button @click="addVirtualNode()" class="px-4 py-2 bg-blue-500 text-white text-[10px] font-black rounded-xl hover:bg-blue-400 transition shadow-lg shadow-blue-500/20">+ 增加虚拟小鸡</button>
                </div>
                <div class="space-y-3">
                    <template x-for="(n, sid) in sortedAgents" :key="sid">
                        <div class="flex items-center justify-between bg-white/2 p-4 rounded-2xl border border-white/5 hover:border-white/10 transition group">
                            <div class="flex items-center gap-4">
                                <div class="flex flex-col items-center"><span class="text-[8px] text-slate-600 font-bold uppercase">Order</span><input type="number" x-model="n.order" @change="manageAgent(sid, 'reorder', n.order)" class="w-10 bg-black/40 text-center font-black text-xs text-blue-400 outline-none rounded-md border border-white/5"></div>
                                <div class="h-8 w-px bg-white/10"></div>
                                <div><div class="flex items-center gap-2">
                                        <span x-show="editingSid !== sid" class="text-sm font-bold text-white" x-text="n.alias || n.hostname"></span>
                                        <input x-show="editingSid === sid" x-model="tempAlias" class="bg-black/40 border border-blue-500/50 px-2 py-0.5 rounded text-xs text-blue-400 outline-none font-bold">
                                        <button @click="if(editingSid === sid){ saveAlias(sid) }else{ editingSid = sid; tempAlias = n.alias || n.hostname }" class="transition-all" :class="editingSid === sid ? 'text-green-500' : 'text-slate-500 hover:text-blue-400'"><i :class="editingSid === sid ? 'ri-checkbox-circle-fill text-lg' : 'ri-edit-box-line text-sm'"></i></button>
                                        <template x-if="n.is_demo"><span class="text-[7px] px-1.5 py-0.5 bg-blue-500/20 text-blue-400 rounded border border-blue-500/30 font-bold uppercase">Demo</span></template>
                                    </div><span class="text-[8px] text-slate-600 font-mono tracking-tight" x-text="'ID: ' + sid"></span>
                                </div>
                            </div>
                            <button @click="manageAgent(sid, 'delete')" class="w-10 h-10 flex items-center justify-center text-slate-700 hover:text-red-500 transition"><i class="ri-delete-bin-line text-lg"></i></button>
                        </div>
                    </template>
                </div>
            </section>
            <div class="mt-8 pt-6 border-t border-white/5"><button @click="logout()" class="w-full py-3 bg-red-500/10 text-red-500 border border-red-500/20 rounded-xl text-[10px] font-black uppercase hover:bg-red-500 transition"><i class="ri-logout-box-r-line mr-2"></i> 退出管理系统</button></div>
        </div>
    </div>
</div>

<script>
function multix() {
    return {
        agents: {}, master: {}, config: {}, 
        drawer: false, adminModal: false, isRefreshing: false,
        curSid: '', curNode: {}, editNodes: [],
        isEditingUser: false, isEditingPass: false, editingSid: null, 
        tempUser: '', tempPass: '', tempAlias: '',

        async init() {
            await this.fetchState();
            setInterval(() => this.fetchState(), 3000);
        },
        async fetchState() {
            try {
                const r = await fetch('/api/state');
                const d = await r.json();
                this.agents = d.agents || {};
                this.master = d.master || {};
                this.config = d.config || {};
                if(this.drawer && this.curSid) this.curNode = this.agents[this.curSid];
            } finally { this.isRefreshing = false; }
        },
        openAdminModal() {
            this.tempUser = this.config.user;
            this.tempPass = '';
            this.isEditingUser = false;
            this.isEditingPass = false;
            this.adminModal = true;
        },
        async confirmUpdateAdmin() {
            const res = await fetch('/api/update_admin', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user: this.tempUser, pass: this.tempPass || null })
            });
            if(res.ok) { this.isEditingUser = false; this.isEditingPass = false; await this.fetchState(); alert("管理员账户已安全同步"); }
        },
        async addVirtualNode() {
            await fetch('/api/add_demo', { method: 'POST' });
            await this.fetchState();
        },
        async saveAlias(sid) {
            await this.manageAgent(sid, 'rename', this.tempAlias);
            this.editingSid = null; await this.fetchState();
        },
        async manageAgent(sid, action, value) {
            await fetch('/api/manage_agent', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sid: sid, action: action, name: action === 'rename' ? value : null, order: action === 'reorder' ? parseInt(value) : null })
            });
            if (action === 'delete') await this.fetchState();
        },
        get sortedAgents() {
            return Object.fromEntries(Object.entries(this.agents).sort(([,a], [,b]) => (a.order || 0) - (b.order || 0)));
        },
        logout() { if(confirm("确定退出管理面板吗？")) window.location.reload(); },
        openDrawer(sid) {
            this.curSid = sid;
            this.curNode = this.agents[sid];
            this.editNodes = JSON.parse(JSON.stringify(this.curNode.draft_nodes || this.curNode.physical_nodes || []));
            this.drawer = true;
        },
        addEmptyNode() { this.editNodes.push({ tag: 'Node_'+Math.random().toString(36).slice(-4), type: 'vless', listen_port: 443, uuid: crypto.randomUUID() }); },
        async saveDraft() {
            const r = await fetch('/api/save_draft', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({sid: this.curSid, nodes: this.editNodes}) });
            if(r.ok) { this.drawer = false; this.fetchState(); }
        },
        async syncPush() {
            if(!confirm("即时下发将重启节点服务，继续？")) return;
            await this.saveDraft();
            const r = await fetch('/api/sync_push', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({sid: this.curSid}) });
            if(r.ok) { alert("下发成功！"); this.drawer = false; }
        }
    }
}
</script>
</body>
</html>
