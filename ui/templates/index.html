<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTIX PRO | 诸元集群探针</title>
    <script src="/static/tailwind.js"></script>
    <script defer src="/static/alpine.js"></script>
    <script src="/static/qrcode.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/custom.css">
</head>
<body x-data="multix()" x-init="init()" class="antialiased font-sans pb-20 bg-[#020617] text-[#f8fafc] custom-scrollbar">

    <header class="max-w-7xl mx-auto px-6 pt-8 flex justify-between items-center">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-3">
                <h1 class="text-3xl font-black italic tracking-tighter text-blue-500">MULTIX <span class="text-white">PRO</span></h1>
                <span class="bg-blue-500/10 text-blue-400 text-[10px] px-2 py-1 rounded font-bold uppercase border border-blue-500/20">Master</span>
            </div>
            
            <template x-if="isLoggedIn">
                <div class="flex gap-2 animate-in fade-in slide-in-from-left-4 duration-500">
                    <button @click="exportGlobalNodes()" class="flex items-center gap-2 px-4 py-2 bg-blue-500/10 text-blue-500 rounded-xl hover:bg-blue-600 hover:text-white transition-all text-[10px] font-black uppercase tracking-widest border border-blue-500/10">
                        <i class="ri-qr-code-line"></i> 超级导出
                    </button>
                    <button @click="subModal = true" class="flex items-center gap-2 px-4 py-2 bg-emerald-500/10 text-emerald-500 rounded-xl hover:bg-emerald-600 hover:text-white transition-all text-[10px] font-black uppercase tracking-widest border border-emerald-500/10">
                        <i class="ri-rss-line"></i> 一键订阅
                    </button>
                </div>
            </template>
        </div>
        
        <div class="flex items-center gap-4">
            <button @click="isRefreshing=true; fetchState()" class="p-2 hover:bg-white/5 rounded-full transition" :class="isRefreshing && 'animate-spin-slow'">
                <i class="ri-refresh-line text-xl text-slate-400"></i>
            </button>

            <div @click="isLoggedIn ? adminModal = true : showLoginModal = true" 
                 class="flex items-center gap-2 px-4 py-2 bg-white/5 rounded-2xl border border-white/10 cursor-pointer hover:bg-white/10 transition group">
                <div class="w-1.5 h-1.5 rounded-full" :class="isLoggedIn ? 'bg-green-500 animate-pulse' : 'bg-slate-500'"></div>
                <div class="flex flex-col">
                    <span class="text-[8px] text-slate-500 font-black uppercase leading-none mb-1">Status</span>
                    <span class="text-xs font-black italic tracking-tighter text-white group-hover:text-blue-400 transition" 
                          x-text="isLoggedIn ? (config.user || 'ADMIN') : 'GUEST / 点击登录'"></span>
                </div>
            </div>
        </div>
    </header>

    <section class="max-w-7xl mx-auto px-6 mt-8">
        <div class="glass-flat p-6 rounded-[2.5rem] flex flex-wrap items-center justify-between gap-6 border border-white/5">
            <div class="flex items-center gap-6">
                <div class="bg-blue-600/20 p-4 rounded-2xl border border-blue-500/20">
                    <i class="ri-server-line text-2xl text-blue-400"></i>
                </div>
                <div>
                    <h2 class="text-lg font-black uppercase italic tracking-tight">Master Console</h2>
                    <div class="flex gap-4 mt-1 text-[10px] text-slate-400 font-mono">
                        <span x-text="'OS: ' + master.sys_ver"></span>
                        <span class="text-blue-400" x-text="'SB: ' + (master.sb_ver || 'N/A')"></span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-8 text-center bg-black/20 px-8 py-3 rounded-2xl border border-white/5">
                <div><p class="text-[8px] text-slate-500 uppercase font-black">CPU</p><p class="text-sm font-bold" x-text="master.cpu+'%'"></p></div>
                <div><p class="text-[8px] text-slate-500 uppercase font-black">RAM</p><p class="text-sm font-bold" x-text="master.mem+'%'"></p></div>
                <div><p class="text-[8px] text-slate-500 uppercase font-black">IP</p><p class="text-sm font-mono font-bold text-blue-500" x-text="config.ip4 || '---'"></p></div>
            </div>
        </div>
    </section>

    <main class="max-w-7xl mx-auto px-6 mt-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% include 'main_nodes.html' %}
    </main>

    <div x-show="nodeModal" x-cloak class="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-black/90 backdrop-blur-xl">
        <div class="glass-flat w-full max-w-4xl rounded-[3rem] shadow-2xl flex flex-col max-h-[90vh] overflow-hidden border border-white/10">
            <div class="p-8 border-b border-white/5 flex justify-between items-center bg-white/5">
                <div>
                    <h2 class="text-2xl font-black italic tracking-tighter uppercase" x-text="currentNode?.alias || currentNode?.hostname"></h2>
                    <p class="text-[10px] text-blue-500 font-mono mt-1" x-text="'Node ID: ' + currentNode?.sid"></p>
                </div>
                <button @click="nodeModal = false" class="ri-close-circle-fill text-3xl text-slate-500 hover:text-white transition-colors"></button>
            </div>

            <div class="flex-1 overflow-y-auto p-8 custom-scrollbar space-y-8">
                <div class="space-y-3">
                    <div class="flex justify-between items-center px-2">
                        <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Active Inbounds</span>
                        <button @click="addNewDraft()" class="text-[10px] font-black text-blue-500 uppercase hover:text-blue-400">+ Add New Inbound</button>
                    </div>
                    <template x-for="(inb, idx) in currentNodeInbounds" :key="idx">
                        <div class="p-4 bg-white/5 rounded-3xl border border-white/5 flex justify-between items-center group hover:border-blue-500/30 transition-all">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-blue-600/20 text-blue-400 flex items-center justify-center font-black text-[10px]" x-text="inb.type.toUpperCase()"></div>
                                <div>
                                    <div class="font-bold text-sm text-white" x-text="inb.tag"></div>
                                    <div class="text-[9px] text-slate-500 font-mono" x-text="'PORT: ' + (inb.listen_port || inb.port)"></div>
                                </div>
                            </div>
                            <div class="flex gap-2 opacity-40 group-hover:opacity-100 transition-opacity">
                                <button @click="editInbound(idx)" class="w-8 h-8 flex items-center justify-center bg-white/5 hover:bg-white/10 rounded-lg"><i class="ri-pencil-line"></i></button>
                                <button @click="deleteInbound(idx)" class="w-8 h-8 flex items-center justify-center bg-red-500/5 text-red-500 hover:bg-red-500/20 rounded-lg"><i class="ri-delete-bin-line"></i></button>
                            </div>
                        </div>
                    </template>
                </div>

                <template x-if="editingInbound">
                    <div class="p-8 bg-blue-600/5 rounded-[2.5rem] border border-blue-600/10 space-y-6 animate-in slide-in-from-top-4">
                        <div class="grid grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] text-slate-500 uppercase font-black px-2 tracking-widest">Protocol</label>
                                <select x-model="editingInbound.type" class="w-full bg-black/60 border border-white/10 rounded-2xl p-4 text-sm focus:border-blue-500 outline-none transition-all">
                                    <option value="vless">VLESS</option>
                                    <option value="vmess">VMESS</option>
                                    <option value="hysteria2">Hysteria2</option>
                                    <option value="shadowsocks">Shadowsocks</option>
                                    <option value="json">自定义 JSON (Append)</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] text-slate-500 uppercase font-black px-2 tracking-widest">Tag (Node Name)</label>
                                <input type="text" x-model="editingInbound.tag" class="w-full bg-black/60 border border-white/10 rounded-2xl p-4 text-sm focus:border-blue-500 outline-none">
                            </div>
                        </div>

                        <template x-if="editingInbound.type === 'vless'">
                            <div class="space-y-6">
                                <div class="space-y-2">
                                    <label class="text-[10px] text-slate-500 uppercase font-black px-2">UUID</label>
                                    <div class="flex gap-2">
                                        <input type="text" x-model="editingInbound.uuid" class="flex-1 bg-black/60 border border-white/10 rounded-2xl p-4 text-xs font-mono text-blue-400">
                                        <button @click="editingInbound.uuid = crypto.randomUUID()" class="px-6 bg-white/5 rounded-2xl hover:bg-white/10 transition-all"><i class="ri-refresh-line"></i></button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div class="space-y-2">
                                        <label class="text-[10px] text-slate-500 uppercase font-black px-2">Reality Private Key</label>
                                        <input type="text" x-model="editingInbound.reality_priv" class="w-full bg-black/60 border border-white/10 rounded-2xl p-4 text-xs font-mono">
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-[10px] text-slate-500 uppercase font-black px-2">Port</label>
                                        <input type="number" x-model="editingInbound.listen_port" class="w-full bg-black/60 border border-white/10 rounded-2xl p-4 text-sm font-mono">
                                    </div>
                                </div>
                            </div>
                        </template>

                        <template x-if="editingInbound.type === 'json'">
                            <div class="space-y-2">
                                <label class="text-[10px] text-orange-500 uppercase font-black px-2">Raw Inbound JSON</label>
                                <textarea x-model="editingInbound.raw_json" rows="8" class="w-full bg-black/60 border border-white/10 rounded-3xl p-6 text-[10px] font-mono focus:border-orange-500 outline-none" placeholder='{"type": "vmess", "tag": "test", ...}'></textarea>
                            </div>
                        </template>

                        <button @click="saveInboundDraft()" class="w-full py-4 bg-blue-600 rounded-3xl font-black text-xs uppercase tracking-widest hover:bg-blue-500 transition-all shadow-xl shadow-blue-900/40">确认节点草稿</button>
                    </div>
                </template>
            </div>

            <div class="p-8 border-t border-white/5 bg-black/40 flex gap-4">
                <button @click="syncConfigToAgent()" class="flex-1 py-5 bg-white text-black rounded-3xl font-black uppercase text-xs tracking-widest hover:scale-[0.98] transition-all">同步全量配置至小鸡</button>
            </div>
        </div>
    </div>

    <div x-show="subModal" x-cloak class="fixed inset-0 z-[160] flex items-center justify-center p-4 bg-black/95 backdrop-blur-2xl">
        <div class="glass-flat w-full max-w-2xl rounded-[3rem] p-12 border border-emerald-500/20 shadow-2xl animate-in zoom-in duration-300">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-3xl font-black italic tracking-tighter text-white uppercase">Subscription</h2>
                <button @click="subModal = false" class="ri-close-circle-fill text-3xl text-slate-500 hover:text-white transition-colors"></button>
            </div>
            <div class="space-y-8">
                <div class="space-y-3">
                    <label class="text-[10px] text-slate-500 uppercase font-black px-2 tracking-[0.2em]">Select Format</label>
                    <select x-model="subType" class="w-full bg-white/5 border border-white/10 rounded-2xl p-5 text-sm text-white focus:border-emerald-500 outline-none transition-all">
                        <option value="v2ray">V2Ray / Shadowrocket (Base64)</option>
                        <option value="clash">Clash (YAML)</option>
                    </select>
                </div>
                <div class="space-y-3">
                    <label class="text-[10px] text-slate-500 uppercase font-black px-2 tracking-[0.2em]">Your Private Link</label>
                    <div class="relative group">
                        <input type="text" readonly :value="generateSubLink()" class="w-full bg-black border border-white/10 rounded-3xl p-5 text-xs text-emerald-400 font-mono pr-24 outline-none">
                        <button @click="copyToClipboard(generateSubLink())" class="absolute right-3 top-3 px-4 py-2 bg-emerald-600 text-white text-[10px] font-black rounded-xl hover:bg-emerald-500 transition-all">COPY</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div x-show="globalExportModal" x-cloak class="fixed inset-0 z-[160] flex items-center justify-center p-4 bg-black/95 backdrop-blur-2xl">
        <div class="glass-flat w-full max-w-3xl rounded-[3rem] p-12 animate-in zoom-in duration-300 border border-blue-500/20 shadow-2xl">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-3xl font-black italic tracking-tighter text-white uppercase">Global Export</h2>
                <button @click="globalExportModal = false" class="ri-close-circle-fill text-3xl text-slate-500 hover:text-white transition-colors"></button>
            </div>
            <div class="space-y-8 flex flex-col items-center">
                <textarea readonly x-model="globalLinks" class="w-full h-40 bg-black border border-white/10 rounded-3xl p-6 text-[10px] font-mono text-blue-400 outline-none scrollbar-hide"></textarea>
                <div class="bg-white p-4 rounded-[2.5rem] shadow-2xl border-8 border-white">
                    <canvas id="global-qr-canvas"></canvas>
                </div>
                <button @click="copyToClipboard(globalLinks)" class="px-12 py-4 bg-blue-600 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-blue-500 transition-all">Copy All Links</button>
            </div>
        </div>
    </div>

    {% include 'modals/login_modal.html' %}
    {% include 'modals/admin_modal.html' %}

    <script src="static/dashboard.js"></script>

</body>
</html>
