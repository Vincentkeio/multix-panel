<div id="modals-system">

    {% include 'modals/login_modal.html' %}

    {% include 'modals/admin_modal.html' %}

    <div x-show="nodeModal" x-cloak class="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-black/90 backdrop-blur-xl animate-in fade-in duration-300">
        <div class="glass-flat w-full max-w-4xl rounded-[3rem] shadow-2xl flex flex-col max-h-[90vh] overflow-hidden border border-white/10">
            <div class="p-8 border-b border-white/5 flex justify-between items-center bg-white/5">
                <div>
                    <h2 class="text-2xl font-black italic tracking-tighter uppercase text-white" x-text="currentNode?.alias || currentNode?.hostname"></h2>
                    <p class="text-[10px] text-blue-500 font-black uppercase tracking-widest mt-1" x-text="'NODE SID: ' + currentNode?.sid"></p>
                </div>
                <button @click="nodeModal = false" class="ri-close-circle-fill text-3xl text-slate-500 hover:text-white transition-colors"></button>
            </div>

            <div class="flex-1 overflow-y-auto p-8 custom-scrollbar space-y-8">
                <div class="space-y-4">
                    <div class="flex justify-between items-center px-2">
                        <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">活跃入站列表 (Active Inbounds)</span>
                        <button @click="addNewDraft()" class="text-[10px] font-black text-blue-500 uppercase hover:text-blue-400 border-b border-blue-500/20">+ 新增入站</button>
                    </div>
                    <template x-for="(inb, idx) in currentNodeInbounds" :key="idx">
                        <div class="p-4 bg-white/5 rounded-3xl border border-white/5 flex justify-between items-center group hover:border-blue-500/30 transition-all">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-blue-600/20 text-blue-400 flex items-center justify-center font-black text-[10px]" x-text="inb.type.toUpperCase()"></div>
                                <div>
                                    <div class="font-bold text-sm text-white" x-text="inb.tag"></div>
                                    <div class="text-[9px] text-slate-500 font-mono" x-text="'PORT: ' + (inb.listen_port || inb.port)"></div>
                                </div>
                            </div>
                            <div class="flex gap-2 opacity-40 group-hover:opacity-100 transition-opacity">
                                <button @click="editInbound(idx)" class="w-8 h-8 flex items-center justify-center bg-white/5 hover:bg-white/10 rounded-lg text-blue-400 transition-all"><i class="ri-pencil-line"></i></button>
                                <button @click="deleteInbound(idx)" class="w-8 h-8 flex items-center justify-center bg-red-500/5 text-red-500 hover:bg-red-500/20 rounded-lg transition-all"><i class="ri-delete-bin-line"></i></button>
                            </div>
                        </div>
                    </template>
                </div>

                <template x-if="editingInbound">
                    <div class="p-8 bg-blue-600/5 rounded-[2.5rem] border border-blue-600/10 space-y-6 animate-in slide-in-from-top-4">
                        <div class="grid grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] text-slate-500 uppercase font-black px-2 tracking-widest">协议类型</label>
                                <select x-model="editingInbound.type" class="w-full bg-black/60 border border-white/10 rounded-2xl p-4 text-sm focus:border-blue-500 outline-none text-white transition-all appearance-none">
                                    <option value="vless">VLESS (Reality)</option>
                                    <option value="vmess">VMESS</option>
                                    <option value="hysteria2">Hysteria2</option>
                                    <option value="shadowsocks">Shadowsocks</option>
                                    <option value="json">自定义 JSON (高级)</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] text-slate-500 uppercase font-black px-2 tracking-widest">节点标识 (Tag)</label>
                                <input type="text" x-model="editingInbound.tag" class="w-full bg-black/60 border border-white/10 rounded-2xl p-4 text-sm focus:border-blue-500 outline-none text-white">
                            </div>
                        </div>

                        <template x-if="editingInbound.type === 'vless'">
                            <div class="space-y-6">
                                <div class="space-y-2">
                                    <label class="text-[10px] text-slate-500 uppercase font-black px-2">用户 UUID</label>
                                    <div class="flex gap-2">
                                        <input type="text" x-model="editingInbound.uuid" class="flex-1 bg-black/60 border border-white/10 rounded-2xl p-4 text-xs font-mono text-blue-400">
                                        <button @click="editingInbound.uuid = crypto.randomUUID()" class="px-6 bg-white/5 rounded-2xl hover:bg-white/10 text-white transition-all"><i class="ri-refresh-line"></i></button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div class="space-y-2">
                                        <label class="text-[10px] text-slate-500 uppercase font-black px-2">Reality 私钥 (自动匹配公钥)</label>
                                        <div class="flex gap-2">
                                            <input type="text" x-model="editingInbound.reality_priv" class="flex-1 bg-black/60 border border-white/10 rounded-2xl p-4 text-xs font-mono text-white">
                                            <button @click="generateRealityKeys()" class="px-4 bg-blue-500/20 text-blue-400 rounded-2xl hover:bg-blue-500 hover:text-white transition-all text-[10px] font-bold uppercase">Generate</button>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-[10px] text-slate-500 uppercase font-black px-2">监听端口</label>
                                        <input type="number" x-model="editingInbound.listen_port" class="w-full bg-black/60 border border-white/10 rounded-2xl p-4 text-sm font-mono text-white">
                                    </div>
                                </div>
                            </div>
                        </template>

                        <button @click="saveInboundDraft()" class="w-full py-4 bg-blue-600 rounded-3xl font-black text-xs uppercase tracking-widest hover:bg-blue-500 transition-all shadow-xl shadow-blue-900/40 text-white">保存当前节点修改</button>
                    </div>
                </template>
            </div>

            <div class="p-8 border-t border-white/5 bg-black/40 flex gap-4">
                <button @click="syncConfigToAgent()" class="flex-1 py-5 bg-white text-black rounded-3xl font-black uppercase text-xs tracking-widest hover:scale-[0.98] transition-all shadow-lg shadow-white/10">同步配置至远端小鸡</button>
            </div>
        </div>
    </div>

    <div x-show="subModal" x-cloak class="fixed inset-0 z-[160] flex items-center justify-center p-4 bg-black/95 backdrop-blur-2xl animate-in zoom-in duration-300">
        <div class="glass-flat w-full max-w-2xl rounded-[3rem] p-12 border border-emerald-500/20 shadow-2xl">
            <div class="flex justify-between items-center mb-10">
                <div class="flex items-center gap-3">
                    <i class="ri-rss-line text-3xl text-emerald-400"></i>
                    <h2 class="text-3xl font-black italic tracking-tighter text-white uppercase">Subscription</h2>
                </div>
                <button @click="subModal = false" class="ri-close-circle-fill text-3xl text-slate-500 hover:text-white transition-colors"></button>
            </div>
            <div class="space-y-8">
                <div class="space-y-3">
                    <label class="text-[10px] text-slate-500 uppercase font-black px-2 tracking-[0.2em]">订阅格式</label>
                    <select x-model="subType" class="w-full bg-white/5 border border-white/10 rounded-2xl p-5 text-sm text-white focus:border-emerald-500 outline-none transition-all appearance-none">
                        <option value="v2ray">V2Ray / Shadowrocket (Base64)</option>
                        <option value="clash">Clash Meta (YAML)</option>
                    </select>
                </div>
                <div class="space-y-3">
                    <label class="text-[10px] text-slate-500 uppercase font-black px-2 tracking-[0.2em]">专用订阅链接</label>
                    <div class="relative group">
                        <input type="text" readonly :value="generateSubLink()" class="w-full bg-black border border-white/10 rounded-3xl p-5 text-xs text-emerald-400 font-mono pr-24 outline-none">
                        <button @click="copyToClipboard(generateSubLink())" class="absolute right-3 top-3 px-4 py-2 bg-emerald-600 text-white text-[10px] font-black rounded-xl hover:bg-emerald-500 transition-all uppercase">Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div x-show="globalExportModal" x-cloak class="fixed inset-0 z-[160] flex items-center justify-center p-4 bg-black/95 backdrop-blur-2xl animate-in zoom-in duration-300">
        <div class="glass-flat w-full max-w-3xl rounded-[3rem] p-12 border border-blue-500/20 shadow-2xl text-center">
            <div class="flex justify-between items-center mb-10">
                <div class="flex items-center gap-3">
                    <i class="ri-qr-code-line text-3xl text-blue-400"></i>
                    <h2 class="text-3xl font-black italic tracking-tighter text-white uppercase tracking-widest">Global Export</h2>
                </div>
                <button @click="globalExportModal = false" class="ri-close-circle-fill text-3xl text-slate-500 hover:text-white transition-colors"></button>
            </div>
            <div class="space-y-8 flex flex-col items-center">
                <textarea readonly x-model="globalLinks" class="w-full h-40 bg-black border border-white/10 rounded-3xl p-6 text-[10px] font-mono text-blue-400 outline-none custom-scrollbar"></textarea>
                <div class="bg-white p-4 rounded-[2.5rem] shadow-2xl border-8 border-white overflow-hidden">
                    <div id="global-qr-code"></div>
                </div>
                <div class="flex gap-4 w-full">
                    <button @click="copyToClipboard(globalLinks)" class="flex-1 py-4 bg-blue-600 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-blue-500 transition-all text-white">复制全量链接</button>
                    <button @click="downloadQR()" class="px-8 py-4 bg-white/10 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-white/20 transition-all text-white">下载二维码</button>
                </div>
            </div>
        </div>
    </div>

</div>
